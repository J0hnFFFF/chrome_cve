# Phase 4 - CLI äº¤äº’å¢å¼ºä½¿ç”¨æŒ‡å—

## åŠŸèƒ½æ¦‚è¿°

Phase 4 ä¸ºä¸“å®¶è¯„å®¡ç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„å¯Œæ–‡æœ¬ç»ˆç«¯ç•Œé¢ï¼Œä½¿ç”¨ Rich åº“å®ç°è¯­æ³•é«˜äº®ã€è¡¨æ ¼å±•ç¤ºå’Œäº¤äº’å¼æ§åˆ¶å°ã€‚

### æ ¸å¿ƒæ”¹è¿›
1. **Rich UI é›†æˆ**: è¯­æ³•é«˜äº®ã€Panelã€Table ç­‰ç°ä»£ç»ˆç«¯ç»„ä»¶
2. **å¢å¼ºçš„äº¤äº’é€‰é¡¹**: è¯¦æƒ…æŸ¥çœ‹ã€ç›¸ä¼¼æ¡ˆä¾‹ã€æ‰¹æ¬¡ç»“æœå±•ç¤º
3. **ä¼˜é›…é™çº§**: æ—  Rich åº“æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°çº¯æ–‡æœ¬æ¨¡å¼
4. **æ‰¹é‡éªŒè¯å±•ç¤º**: ä¸“ä¸ºå¹¶è¡ŒéªŒè¯ç»“æœè®¾è®¡çš„è¡¨æ ¼è§†å›¾

---

## 1. Rich åº“é›†æˆ

### å®‰è£…

```bash
pip install rich
```

### è‡ªåŠ¨æ£€æµ‹

æ¡†æ¶ä¼šè‡ªåŠ¨æ£€æµ‹ Rich æ˜¯å¦å¯ç”¨ï¼š
- **æœ‰ Rich**: ä½¿ç”¨å¢å¼ºå‹ UI
- **æ—  Rich**: é™çº§åˆ°çº¯æ–‡æœ¬æ¨¡å¼

```python
from browser.review.expert_review import ExpertReviewCLI

cli = ExpertReviewCLI()
# è‡ªåŠ¨é€‰æ‹©æœ€ä½³ UI æ¨¡å¼
```

---

## 2. å¢å¼ºçš„è¯„å®¡ç•Œé¢

### è¯­æ³•é«˜äº®çš„ PoC æ˜¾ç¤º

ä½¿ç”¨ Monokai ä¸»é¢˜çš„ JavaScript è¯­æ³•é«˜äº®ï¼š

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    Generated PoC                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  1 â”‚ function trigger() {                                    â•‘
â•‘  2 â”‚   let arr = new Array(0x1000);                          â•‘
â•‘  3 â”‚   %OptimizeFunctionOnNextCall(trigger);                 â•‘
â•‘  4 â”‚   // Type confusion here                                â•‘
â•‘  5 â”‚   return arr[0xdeadbeef];                               â•‘
â•‘  6 â”‚ }                                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### å…ƒæ•°æ®è¡¨æ ¼

```
                    Metadata                    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Key             â”‚ Value                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ component       â”‚ v8                         â”‚
â”‚ vuln_type       â”‚ type-confusion             â”‚
â”‚ confidence      â”‚ 0.85                       â”‚
â”‚ strategy        â”‚ JIT Optimization           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### äº¤äº’å¼é€‰é¡¹èœå•

```
Review Options:

  Key  Action
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1    âœ“ Accept and verify
  2    âœ Edit PoC
  3    âœ— Reject and regenerate
  4    ğŸ’¬ Add feedback only
  5    â­  Skip review
  D    ğŸ“„ View details
  S    ğŸ” View similar cases

Choice [1/2/3/4/5/d/D/s/S] (1):
```

---

## 3. è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½

### ä½¿ç”¨æ–¹æ³•

åœ¨è¯„å®¡ç•Œé¢æŒ‰ `D` æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼š

```python
# åœ¨è¯„å®¡æ—¶
result = cli.request_review(
    poc_code=poc_code,
    cve_id="CVE-2021-21220",
    metadata={
        "analysis": {
            "vulnerability_type": "type-confusion",
            "component": "v8",
            "root_cause": "Missing type check in JSCallReducer",
            "confidence": 0.85
        },
        "verification": {
            "success": True,
            "crash_detected": True,
            "crash_type": "heap-use-after-free",
            "reproducibility": "3/3"
        }
    }
)
```

### è¯¦æƒ…æ˜¾ç¤º

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              Analysis                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Vulnerability Type: type-confusion        â•‘
â•‘ Component: v8                             â•‘
â•‘ Root Cause: Missing type check...         â•‘
â•‘ Confidence: 0.85                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘            Verification                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Success: True                             â•‘
â•‘ Crash Detected: True                      â•‘
â•‘ Crash Type: heap-use-after-free           â•‘
â•‘ Reproducibility: 3/3                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## 4. ç›¸ä¼¼æ¡ˆä¾‹æŸ¥çœ‹

### ä½¿ç”¨æ–¹æ³•

åœ¨è¯„å®¡ç•Œé¢æŒ‰ `S` æŸ¥çœ‹ç›¸ä¼¼çš„å†å²æ¡ˆä¾‹ï¼š

```
                Similar CVEs                
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ CVE ID          â”‚ Similarity â”‚ Success â”‚ Strategy         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CVE-2021-XXXX   â”‚ 0.85       â”‚ âœ“       â”‚ JIT Optimization â”‚
â”‚ CVE-2020-YYYY   â”‚ 0.72       â”‚ âœ“       â”‚ Memory Spray     â”‚
â”‚ CVE-2019-ZZZZ   â”‚ 0.68       â”‚ âœ—       â”‚ Direct Trigger   â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

Note: This is a placeholder. Real implementation would query EpisodeMemory.
```

> **æ³¨æ„**: å½“å‰ä¸ºå ä½ç¬¦å®ç°ã€‚å®Œæ•´ç‰ˆæœ¬å°†æŸ¥è¯¢ `EpisodeMemory` å¹¶è®¡ç®—è¯­ä¹‰ç›¸ä¼¼åº¦ã€‚

---

## 5. æ‰¹é‡éªŒè¯ç»“æœå±•ç¤º

### æ ¸å¿ƒåŠŸèƒ½

`display_batch_results` æ–¹æ³•ä¸“ä¸º Phase 2.1 çš„å¹¶è¡ŒéªŒè¯è®¾è®¡ï¼š

```python
from browser.review.expert_review import ExpertReviewCLI

cli = ExpertReviewCLI()

# æ˜¾ç¤ºæ‰¹é‡éªŒè¯ç»“æœ
cli.display_batch_results(batch_results)
```

### è¾“å‡ºç¤ºä¾‹

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        Batch Verification Summary                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Total Candidates: 3                                      â•‘
â•‘ Verified: 3                                              â•‘
â•‘ Crashed: 1                                               â•‘
â•‘ Success Rate: 33.3%                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                  Candidate Results                  
â•­â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ # â”‚ Strategy         â”‚ Status      â”‚ Crash Type   â”‚ Time (s) â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1 â”‚ Template-based   â”‚ â—‹ No Crash  â”‚ -            â”‚     2.34 â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2 â”‚ JIT Optimization â”‚ âœ“ Crashed   â”‚ UAF          â”‚     3.12 â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3 â”‚ Memory Spray     â”‚ â—‹ No Crash  â”‚ -            â”‚     2.89 â”‚
â•°â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              âœ“ Successful Crash                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Best Candidate: #2                                       â•‘
â•‘ Strategy: JIT Optimization                               â•‘
â•‘ Crash Type: heap-use-after-free                          â•‘
â•‘ Execution Time: 3.12s                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## 6. å®Œæ•´å·¥ä½œæµç¤ºä¾‹

### å•ä¸ª PoC è¯„å®¡

```python
from browser.review.expert_review import ExpertReviewCLI

cli = ExpertReviewCLI()

# è¯·æ±‚è¯„å®¡
result = cli.request_review(
    poc_code=generated_poc,
    cve_id="CVE-2021-21220",
    metadata={
        "component": "v8",
        "strategy": "JIT Optimization",
        "confidence": 0.85
    }
)

# å¤„ç†ç»“æœ
if result.action == "accept":
    print("PoC accepted, proceeding to verification...")
elif result.action == "edit":
    print(f"PoC modified: {result.feedback}")
    # ä½¿ç”¨ result.modified_code
elif result.action == "reject":
    print(f"PoC rejected: {result.feedback}")
    # é‡æ–°ç”Ÿæˆ
```

### æ‰¹é‡éªŒè¯å±•ç¤º

```python
# ç”Ÿæˆå¤šä¸ªå€™é€‰
candidates = generator.generate_candidates(analysis, cve_info, num_candidates=3)

# å¹¶å‘éªŒè¯
batch_results = verifier.verify_batch(candidates, d8_path=d8_path)

# å±•ç¤ºç»“æœ
cli.display_batch_results(batch_results)

# å¦‚æœæœ‰æˆåŠŸçš„ï¼Œè¯·æ±‚è¯„å®¡
if batch_results['first_success']:
    best_idx = batch_results['first_success']['index']
    best_poc = candidates[best_idx]
    
    result = cli.request_review(
        poc_code=best_poc['code'],
        cve_id=cve_id,
        metadata={
            "strategy": best_poc['strategy'],
            "verification": batch_results['first_success']
        }
    )
```

---

## 7. é™çº§æ¨¡å¼

### æ—  Rich åº“æ—¶çš„è¡Œä¸º

```
======================================================================
PoC Review Required: CVE-2021-21220
======================================================================

Metadata:
  component: v8
  strategy: JIT Optimization

Generated PoC (preview):
----------------------------------------------------------------------
  1 | function trigger() {
  2 |   let arr = new Array(0x1000);
  3 |   %OptimizeFunctionOnNextCall(trigger);
  4 |   return arr[0xdeadbeef];
  5 | }
----------------------------------------------------------------------

Review Options:
  1. Accept and verify
  2. Edit PoC
  3. Reject and regenerate
  4. Add feedback only
  5. Skip review

Choice [1-5]:
```

---

## 8. é…ç½®ä¸è‡ªå®šä¹‰

### è‡ªå®šä¹‰ç¼–è¾‘å™¨

```bash
# Windows
set EDITOR=code

# Linux/Mac
export EDITOR=vim
```

### ç¦ç”¨ Richï¼ˆå¼ºåˆ¶çº¯æ–‡æœ¬æ¨¡å¼ï¼‰

```python
cli = ExpertReviewCLI()
cli.use_rich = False  # å¼ºåˆ¶ä½¿ç”¨çº¯æ–‡æœ¬æ¨¡å¼
```

---

## æ€»ç»“

Phase 4 å°†ä¸“å®¶è¯„å®¡ä½“éªŒæå‡åˆ°äº†æ–°çš„æ°´å¹³ï¼š

- âœ… **è§†è§‰å¢å¼º**: è¯­æ³•é«˜äº®ã€å½©è‰²è¡¨æ ¼ã€å›¾æ ‡
- âœ… **ä¿¡æ¯å¯†åº¦**: åœ¨ä¸€å±å†…å±•ç¤ºæ›´å¤šæœ‰ç”¨ä¿¡æ¯
- âœ… **äº¤äº’æ€§**: è¯¦æƒ…æŸ¥çœ‹ã€ç›¸ä¼¼æ¡ˆä¾‹ã€å¿«æ·é”®
- âœ… **æ‰¹é‡æ”¯æŒ**: ä¸“ä¸ºå¹¶è¡ŒéªŒè¯è®¾è®¡çš„ç»“æœå±•ç¤º
- âœ… **ä¼˜é›…é™çº§**: æ— ä¾èµ–æ—¶ä»ç„¶å¯ç”¨

è¿™äº›æ”¹è¿›ä½¿ä¸“å®¶èƒ½å¤Ÿæ›´å¿«é€Ÿã€æ›´å‡†ç¡®åœ°è¯„ä¼° PoC è´¨é‡ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤šä¸ªå€™é€‰æ—¶ã€‚
